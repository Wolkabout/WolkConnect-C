``` 
██╗    ██╗ ██████╗ ██╗     ██╗  ██╗ ██████╗ ██████╗ ███╗   ██╗███╗   ██╗███████╗ ██████╗████████╗  
██║    ██║██╔═══██╗██║     ██║ ██╔╝██╔════╝██╔═══██╗████╗  ██║████╗  ██║██╔════╝██╔════╝╚══██╔══╝  
██║ █╗ ██║██║   ██║██║     █████╔╝ ██║     ██║   ██║██╔██╗ ██║██╔██╗ ██║█████╗  ██║        ██║     
██║███╗██║██║   ██║██║     ██╔═██╗ ██║     ██║   ██║██║╚██╗██║██║╚██╗██║██╔══╝  ██║        ██║     
╚███╔███╔╝╚██████╔╝███████╗██║  ██╗╚██████╗╚██████╔╝██║ ╚████║██║ ╚████║███████╗╚██████╗   ██║     
 ╚══╝╚══╝  ╚═════╝ ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═╝     
                                                                                                   
                                                                                            ██████╗
                                                                                           ██╔════╝
                                                                                     █████╗██║     
                                                                                     ╚════╝██║     
                                                                                           ╚██████╗
                                                                                            ╚═════╝
```
[![CMake](https:/*github.com/Wolkabout/WolkConnect-C/actions/workflows/cmake.yml/badge.svg?branch=development)](https:/*github.com/Wolkabout/WolkConnect-C/actions/workflows/cmake.yml)
-----
WolkAbout C99 Connector library for connecting devices to WolkAbout IoT platform instance.

WolkConnect-C is transportation layer agnostic which means it is up to the user of the library to open socket to WolkAbout IoT platform,
configure SSL if desired, and forward read/write implementation to WolkConnect-C Connector.
WolkConnect-C Connector is not thread safe, and is written with cooperative scheduling in mind.
This allows WolkConnect-C Connector to work on wide variety of systems, bare metal to OS based ones.

Given examples are intended to be run on Debian based system.

Prerequisite
------
Following tools/libraries are required in order to build WolkConnect-C Connector

* libz-dev & wget
* gcc & g++
* cmake - version 2.8 or later
* libssl-dev
* clang-format
* ruby
* ceedling
* valgrind

Former can be installed on Debian based system from terminal by invoking

`sudo apt-get install libz-dev wget gcc g++ cmake libssl-dev clang-format ruby valgrind`

`gem install ceedling`

When dependencies are installed, Unix Makefiles build system can be generated by invoking `./configure`

Generated build system is located inside `build` directory.

WolkConnect-C Connector library, and example are built from `build` directory by invoking `make all` in terminal.

Library application is built to `out/lib` directory, and example application is built to `out/bin` directory.

Example Usage
-------------
**Initialize WolkConnect-C Connector**

Create a device on WolkAbout IoT platform using [Full Feature Set example](https:/*github.com/Wolkabout/WolkConnect-C/blob/master/examples/full_feature_set/full_example.json) device type. This device type fits `full_feature_set` example and demonstrates all the functionality of WolkConnect-C library.

**Establishing connection with WolkAbout IoT platform:**

```c
/* WolkAbout Platform device connection parameters */
static const char* device_key       = "device_key";
static const char* device_password  = "some_password";
static const char* hostname         = "insert_host";
static int portno                   = 80; // TODO: insert port
static char certs[]                 = "../ca.crt";

/* Sample in-memory persistence storage - size 1MB */
static uint8_t persistence_storage[1024 * 1024];

/* WolkConnect-C Connector context */
static wolk_ctx_t wolk;

/*...
/*...
/*...

wolk_init(&wolk,                                             /* Context */
          send_buffer,                                       /* See send_func_t */
          receive_buffer,                                    /* See recv_func_t */
          device_key, device_password,                       /* Device key and password provided by WolkAbout IoT Platform upon device creation */
          PUSH,                                              /* Device outbound mode - see outbound_mode_t */
          feed_value_handler,                                /* Feeds handler        - see feed_handler_t */
	      parameter_value_handler,                           /* Parameters handler   - see parameter_handler_t */
	      details_synchronization_value_handler);            /* Details synchronization handler   - see details_synchronization_handler_t */

wolk_init_in_memory_persistence(&wolk,                       /* Context */
                                persistence_storage,         /* Address to start of the memory which will be used by persistence mechanism */
                                sizeof(persistence_storage), /* Size of memory in bytes */
                                false);                      /* If storage is full overwrite the oldest item when pushing */

wolk_connect(&wolk);
```
Considering that WolkConnect C Connector is transportation layer agnostic, it is up to the user of it to open connection to
WolkAbout IoT Platform, optionally setup TLS, and forward read/write callbacks WolkConnect-C Connector in initialization
step.

See `send_func_t` and `send_func_t` in `sources/wolk_connector.h`

***Send feed value example:***
```c
// Numeric
wolk_numeric_feeds_t temperature_value = {0};
temperature_value.value = 23;
wolk_add_numeric_feed(&wolk, "T", &temperature_value, 1)

//Boolean
wolk_boolean_feeds_t switch_value = {0};
switch_value.switch_value = true;
wolk_add_bool_feeds(&wolk, "SW", &switch_value, 1);

```

**Sending parameter example:**
```c
wolk_parameter_t parameter;
wolk_init_parameter(&parameter, PARAMETER_MAXIMUM_MESSAGE_SIZE, "1");
wolk_change_parameter(&wolk, &parameter, 1);
```

**Details synchronization**
Requesting all data about device from the WolkAbout IoT platform example:
```c
wolk_details_synchronization(&wolk)
```
Data will be received at the `details_synchronization_value_handler`.

**Data publish strategy:**

Sensor readings, and alarms are pushed to WolkAbout IoT platform on demand by calling
```c
wolk_publish(&wolk);
```

**Cooperative scheduling:**

Function `wolk_process(wolk_ctx_t *ctx)` is non-blocking in order to comply with cooperative scheduling,
and it must be called periodically.

```c
wolk_process(&wolk, 5);
```

**Disconnecting from the platform:**
```c
wolk_disconnect(&wolk);
```

**Data persistence:**

WolkConnect-C provides mechanism for persisting data in situations where readings can not be sent to WolkAbout IoT platform.
Default implementation can work with in-memory or memory mapped storage.

Persisted readings are sent to WolkAbout IoT platform, in batches, on publish function call.

In cases when provided persistence implementation is suboptimal, one can use custom persistence by providing custom implementation.

```c
wolk_init_custom_persistence(&wolk,
                             persistence_push_impl,
                             persistence_peek_impl, persistence_pop_impl,
                             persistence_is_empty_impl);
```

For more info on persistence mechanism see `sources/persistence/persistence.h` and `sources/persistence/in_memory_persistence.h` files.

**File Management:**

WolkAbout C Connector provides mechanism for file management.

By default this feature is disabled.
See code snippet below on how to enable device file management.
```c
wolk_init_file_management(&wolk,                                        /* Context */
                          128 * 1024 * 1024,                            /* Maximum acceptable size of file, in bytes */
                          1,                                            /* Size of file transfer chunk, in kB, can't be higher that MQTT_PACKET_SIZE. define as parameter on the platform side */
                          file_management_start,                        /* Prepares device for receiving file */
                          file_management_write,                        /* Writes received file chunk */
                          file_management_chunk_read,                   /* Reads requested file chunk */
                          file_management_abort,                        /* Aborts file update sequence */
                          file_management_finalize,                     /* Reboots device */
                          file_management_url_download,                 /* Handler that obtains file from URL */
                          file_management_is_url_download_done,         /* Reports URL download state (in progress | done), and it's result (success | failure) */
                          file_management_get_file_list,                /* Return list of the files from directory `files` */
                          file_management_remove_file,                  /* Delete specific file */
                          file_management_purge_list)                   /* Delete all files from directory `files` */
```

For more info on device File Management mechanism see `sources/model/file_management/file_management.h` file.

**Firmware Update:**

WolkAbout C Connector provides mechanism for triggering Firmware Update. Firmware installation isn't covered, it is platform specific, and it is up to user to implement it.

See code snippet below on how to enable device file management.
```c
wolk_init_firmware_update(&wolk,                                        /* Context */
                          firmware_update_start_installation,           /* Trigger start of the firmware update */
                          firmware_update_is_installation_completed,    /* Check status of the firmware update */
                          firmware_update_verification_store,           /* Store verification parameters into permanent memory, obligatory */
                          firmware_update_verification_read,            /* Read verification parameters from permanent memory */
                          firmware_update_abort_installation)           /* Abort current installation */
```

For more info on device File Management mechanism see `sources/model/firmware_update.h` file.

**Timestamp request**

If you need access to the server's current time, you can request it in the following manner:

```c
wolk_sync_time_request(&wolk)
```
