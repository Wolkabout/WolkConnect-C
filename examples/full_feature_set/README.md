``` 
██╗    ██╗ ██████╗ ██╗     ██╗  ██╗ ██████╗ ██████╗ ███╗   ██╗███╗   ██╗███████╗ ██████╗████████╗  
██║    ██║██╔═══██╗██║     ██║ ██╔╝██╔════╝██╔═══██╗████╗  ██║████╗  ██║██╔════╝██╔════╝╚══██╔══╝  
██║ █╗ ██║██║   ██║██║     █████╔╝ ██║     ██║   ██║██╔██╗ ██║██╔██╗ ██║█████╗  ██║        ██║     
██║███╗██║██║   ██║██║     ██╔═██╗ ██║     ██║   ██║██║╚██╗██║██║╚██╗██║██╔══╝  ██║        ██║     
╚███╔███╔╝╚██████╔╝███████╗██║  ██╗╚██████╗╚██████╔╝██║ ╚████║██║ ╚████║███████╗╚██████╗   ██║     
 ╚══╝╚══╝  ╚═════╝ ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═╝     
                                                                                                   
                                                                                            ██████╗
                                                                                           ██╔════╝
                                                                                     █████╗██║     
                                                                                     ╚════╝██║     
                                                                                           ╚██████╗
                                                                                            ╚═════╝
```
[![Build Status](https://travis-ci.com/Wolkabout/WolkConnect-C.svg?branch=master)](https://travis-ci.com/Wolkabout/WolkConnect-C)
-----
WolkAbout C99 Connector library for connecting devices to WolkAbout IoT platform instance.

WolkConnect-C is transportation layer agnostic which means it is up to the user of the library to open socket to WolkAbout IoT platform,
configure SSL if desired, and forward read/write implementation to WolkConnect-C Connector.
WolkConnect-C Connector is not thread safe, and is written with cooperative scheduling in mind.
This allows WolkConnect-C Connector to work on wide variety of systems, bare metal to OS based ones.

Given examples are intended to be run on Debian based system.

Supported protocol(s):
* JSON single

Prerequisite
------
Following tools/libraries are required in order to build WolkConnect-C Connector

* cmake - version 2.8 or later

Former can be installed on Debian based system from terminal by invoking

`apt-get install cmake`

When dependencies are installed, Unix Makefiles build system can generated by invoking `./configure`

Generated build system is located inside `build` directory.

WolkConnect-C Connector library, and example are built from `build` directory by invoking `make` in terminal.

Library application is built to `out/lib` directory, and example application is built to `out/bin` directory.

Example Usage
-------------
**Initialize WolkConnect-C Connector**

Create a device on WolkAbout IoT platform using [Full example](https://github.com/Wolkabout/WolkConnect-C/blob/master/examples/full_feature_set/full_example.json) device type. This device type fits `full_feature_set` example and demonstrates all the functionality of WolkConnect-C library.

**Establishing connection with WolkAbout IoT platform:**

```c
/* WolkAbout Platform device connection parameters */
static const char* device_key       = "device_key";
static const char* device_password  = "some_password";
static const char* hostname         = "insert_host";
static int portno                   = 80; // TODO: insert port
static char certs[]                 = "../ca.crt";

/* Sample in-memory persistence storage - size 1MB */
static uint8_t persistence_storage[1024 * 1024];

/* WolkConnect-C Connector context */
static wolk_ctx_t wolk;

//...
//...
//...

wolk_init(&wolk,                                             /* Context */
          send_buffer,                                       /* See send_func_t */
          receive_buffer,                                    /* See recv_func_t */
          actuation_handler,                                 /* Actuation handler        - see actuation_handler_t */
          actuator_status_provider,                          /* Actuator status provider - see actuator_status_provider_t */
	  configuration_handler,                             /* Configuration handler        - see configuration_handler_t */
	  configuration_provider,                            /* Configuration status provider - see configuration_provider_t */
          device_key, device_password,                       /* Device key and password provided by WolkAbout IoT Platform upon device creation */
          PROTOCOL_WOLKABOUT,                              /* Protocol specified for device */
          actuator_references,                               /* Array of actuator references */
          num_actuator_references);                          /* Number of actuator references */

wolk_init_in_memory_persistence(&wolk,                       /* Context */
                                persistence_storage,         /* Address to start of the memory which will be used by persistence mechanism */
                                sizeof(persistence_storage), /* Size of memory in bytes */
                                true);                       /* If storage is full overwrite oldest item when pushing */

wolk_connect(&wolk);
```
Considering that WolkConnect C Connector is transportation layer agnostic, it is up to the user of it to open connection to
WolkAbout IoT Platform, optionally setup TLS, and forward read/write callbacks WolkConnect-C Connector in initialization
step.

See `send_func_t` and `send_func_t` in `sources/wolk_connector.h`

**Adding sensor readings:**
```c
wolk_add_numeric_sensor_reading(&wolk, "T", 25.6, 0);

wolk_add_multi_value_numeric_sensor_reading(&wolk, "ACL", &accl_readings, 3, 0);
```

**Adding events:**
```c
wolk_add_alarm(&wolk, "HH", true, 0);
```

**Data publish strategy:**

Sensor readings, and alarms are pushed to WolkAbout IoT platform on demand by calling
```c
wolk_publish(&wolk);
```

**Publishing actuator statuses:**
```c
wolk_publish_actuator_status(&wolk, "SW");
```
This will invoke the `actuator_status_provider` to read the actuator status, and publish actuator status.

**Publish device configuration to platform:**
```c
wolk_publish_configuration_status(&wolk, "CONFIGURATION_REF");
```

**Cooperative scheduling:**

Fuction `wolk_process(wolk_ctx_t *ctx)` is non-blocking in order to comply with cooperative scheduling,
and it must to be called periodically.

```c
wolk_process(&wolk, 5);
```

**Disconnecting from the platform:**
```c
wolk_disconnect(&wolk);
```

**Data persistence:**

WolkConnect-C provides mechanism for persisting data in situations where readings can not be sent to WolkAbout IoT platform.
Default implementation can work with in-memory or memory mapped storage.

Persisted readings are sent to WolkAbout IoT platform, in batches, on publish function call.

In cases when provided persistence implementation is suboptimal, one can use custom persistence by providing custom implementation.

```c
wolk_init_custom_persistence(&wolk,
                             persistence_push_impl,
                             persistence_peek_impl, persistence_pop_impl,
                             persistence_is_empty_impl);
```

For more info on persistence mechanism see `sources/persistence.h` and `sources/in_memory_persistence.h` files.

**File Management:**

WolkAbout C Connector provides mechanism for file management.

By default this feature is disabled.
See code snippet below on how to enable device file management.
```c
wolk_init_file_management(&wolk,
                          128 * 1024 * 1024,                            // Maximum acceptable size of file, in bytes
                          256,                                          // Size of file transfer chunk, in bytes, can't be higher that MQTT_PACKET_SIZE
                          file_management_start,                        // Prepares device for receiving file
                          file_management_write,                        // Writes received file chunk
                          file_management_chunk_read,                   // Reads requested file chunk
                          file_management_abort,                        // Aborts file update sequence
                          file_management_finalize,                     // Reboots device
                          file_management_url_download,                 // Handler that obtains file from URL
                          file_management_is_url_download_done,         // Reports URL download state (in progress | done), and it's result (success | failure)
                          file_management_get_file_list,                // Return list of the files from directory `files`
                          file_management_remove_file,                  // Delete specific file
                          file_management_purge_list)                   // Delete all files from directory `files`
```

For more info on device File Management mechanism see `file_management.h` file.

**Firmware Update:**

WolkAbout C Connector provides mechanism for triggering Firmware Update. Firmware update itself isn't covered, it is platform specific and it is up to user to implement it.

By default this feature is disabled.
See code snippet below on how to enable device file management.
```c
wolk_init_firmware_update(&wolk,
                          firmware_update_start_installation,           // Trigger start of the firmware update
                          firmware_update_is_installation_completed,    // Check status of the firmware update
                          firmware_update_verification_store,           // Store verification parameters into permanent memory, obligatory
                          firmware_update_verification_read,            // Read verification parameters from permanent memory
                          firmware_update_get_version,                  // Return current version of the firmware
                          firmware_update_abort_installation)           // Abort current installation
```

For more info on device File Management mechanism see `firmware_update.h` file.

**Ping Keep Alive Mechanism:**

WolkAbout C Connector by default uses Keep Alive mechanism to notify WolkAbout IoT Platform that device is still connected.
Keep alive message is sent to WolkAbout IoT Platform every 10 minutes.

To reduce network usage Ping Keep Alive mechanism can be disabled in following manner:

```c
wolk_disable_ping_keep_alive(&wolk);
```

**Timestamp request**

If you need access to the server's current time, you can request it in the following manner:

```c
wolk_request_timestamp(&wolk)
```
